<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasoa Pro - V7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .tab-active { background-color: #0f172a; color: white; transform: scale(1.05); }
        .filter-active { background-color: #0f172a; color: white; border-color: #0f172a; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 text-[13px]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const { useState, useEffect, useMemo, createElement: h } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBYcWoieRAH-uY1LXCiXVqLqFdijDo17dI",
            authDomain: "rasoa-pro.firebaseapp.com",
            projectId: "rasoa-pro",
            storageBucket: "rasoa-pro.firebasestorage.app",
            messagingSenderId: "344947402269",
            appId: "1:344947402269:web:76dfee1a27e780e80ac8f4",
            measurementId: "G-NL45NY47LG"
        };

        const appId = "rasoa-pro-v4"; 

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                shoppingCart: h('path', { d: "M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z M3 6h18 M16 10a4 4 0 0 1-8 0" }),
                truck: h('g', null, h('rect', { width: "16", height: "13", x: "2", y: "6", rx: "2" }), h('path', { d: "M16 19h4a2 2 0 0 0 2-2v-5l-3-3h-3" }), h('circle', { cx: "9", cy: "19", r: "2" }), h('circle', { cx: "18", cy: "19", r: "2" })),
                users: h('path', { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" }),
                wallet: h('path', { d: "M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a2 2 0 0 0 0 4h15a1 1 0 0 0 1-1v-4" }),
                plus: h('path', { d: "M12 5v14M5 12h14" }),
                facebook: h('path', { d: "M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" }),
                tiktok: h('path', { d: "M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5" }),
                trendingUp: h('path', { d: "m22 7-8.5 8.5-5-5L2 18M22 7h-6M22 7v6" }),
                check: h('path', { d: "M20 6 9 17l-5-5" }),
                arrowRight: h('path', { d: "M5 12h14M12 5l7 7-7 7" }),
                trash: h('path', { d: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }),
                phone: h('path', { d: "M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" }),
                edit: h('path', { d: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" }),
                mapPin: h('path', { d: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" }),
                bell: h('path', { d: "M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9 M10.3 21a1.94 1.94 0 0 0 3.4 0" }),
                calendar: h('path', { d: "M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z M16 2v4 M8 2v4 M3 10h18" }),
                refresh: h('path', { d: "M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" }),
                fileText: h('path', { d: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2zM14 2v6h6M16 13H8M16 17H8M10 9H8" }),
                chevronRight: h('path', { d: "m9 18 6-6-6-6" }),
                close: h('path', { d: "M18 6 6 18M6 6l12 12" }),
            };
            return h('svg', { 
                width: size, height: size, viewBox: "0 0 24 24", fill: "none", 
                stroke: "currentColor", strokeWidth: "2.5", strokeLinecap: "round", 
                strokeLinejoin: "round", className: className 
            }, icons[name] || null);
        };

        function App() {
            const [db, setDb] = useState(null);
            const [activeTab, setActiveTab] = useState("commandes");
            const [livraisons, setLivraisons] = useState([]);
            const [clients, setClients] = useState([]);
            const [depenses, setDepenses] = useState([]);
            const [deliveryFilter, setDeliveryFilter] = useState("En attente");

            const [showReport, setShowReport] = useState(false);
            const [reportDate, setReportDate] = useState(new Date().toISOString().split('T')[0]);

            const [orderForm, setOrderForm] = useState({ 
                nom: "", telephone: "", montant: "", avance: 0,
                lieu: "", source: "Facebook", paiement: "Paiement sur livraison",
                datePlanif: new Date().toISOString().split('T')[0] 
            });

            const [editingOrder, setEditingOrder] = useState(null);
            const [clientForm, setClientForm] = useState({ nom: "", telephone: "", adresse: "", source: "Facebook" });
            const [expenseForm, setExpenseForm] = useState({ titre: "", montant: "", date: new Date().toISOString().split('T')[0] });
            const [clientSearch, setClientSearch] = useState("");
            const [showSuggestions, setShowSuggestions] = useState(false);

            useEffect(() => {
                const app = initializeApp(firebaseConfig);
                setDb(getFirestore(app));
            }, []);

            useEffect(() => {
                if (!db) return;
                const getColl = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
                const unsubL = onSnapshot(getColl('livraisons'), s => setLivraisons(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubC = onSnapshot(getColl('clients'), s => setClients(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubD = onSnapshot(getColl('depenses'), s => setDepenses(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => { unsubL(); unsubC(); unsubD(); };
            }, [db]);

            const tomorrowStr = useMemo(() => {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow.toISOString().split('T')[0];
            }, []);

            const tomorrowCount = useMemo(() => {
                return livraisons.filter(l => l.datePlanif === tomorrowStr && l.statut !== "Livr√©").length;
            }, [livraisons, tomorrowStr]);

            const counts = useMemo(() => {
                return {
                    "En attente": livraisons.filter(l => l.statut === "En attente" || !l.statut).length,
                    "En cours": livraisons.filter(l => l.statut === "En cours").length,
                    "Livr√©": livraisons.filter(l => l.statut === "Livr√©").length,
                    "Pas encore pay√©": livraisons.filter(l => l.paiement === "Pas encore pay√©").length,
                    "Demain": tomorrowCount
                };
            }, [livraisons, tomorrowCount]);

            const filteredLivraisons = useMemo(() => {
                if (deliveryFilter === "Pas encore pay√©") return livraisons.filter(l => l.paiement === "Pas encore pay√©");
                if (deliveryFilter === "Demain") return livraisons.filter(l => l.datePlanif === tomorrowStr);
                if (deliveryFilter === "En attente") return livraisons.filter(l => (l.statut === "En attente" || !l.statut));
                return livraisons.filter(l => l.statut === deliveryFilter);
            }, [livraisons, deliveryFilter, tomorrowStr]);

            const stats = useMemo(() => {
                const livrees = livraisons.filter(l => l.statut === "Livr√©");
                const totalRevenu = livrees.reduce((acc, l) => acc + (Number(l.montant) || 0), 0);
                const charges = depenses.reduce((acc, c) => acc + (Number(c.montant) || 0), 0);
                return { net: totalRevenu - charges, encaisse: totalRevenu, charges };
            }, [livraisons, depenses]);

            const dayReport = useMemo(() => {
                const sales = livraisons.filter(l => l.statut === "Livr√©" && l.datePlanif === reportDate);
                const dayExp = depenses.filter(d => d.date === reportDate);
                const revenue = sales.reduce((acc, l) => acc + (Number(l.montant) || 0), 0);
                const expenseTotal = dayExp.reduce((acc, d) => acc + (Number(d.montant) || 0), 0);
                return { revenue, expenseTotal, net: revenue - expenseTotal, sales };
            }, [livraisons, depenses, reportDate]);

            const getPaymentColor = (method) => {
                if (method === "Avance") return "bg-blue-100 text-blue-600 border-blue-200";
                if (method === "Pas encore pay√©") return "bg-rose-100 text-rose-600 border-rose-200";
                return "bg-slate-100 text-slate-600 border-slate-200";
            };

            const handleReportTomorrow = async (lId) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', lId), { datePlanif: tomorrowStr });
            };

            const handleCustomDate = async (lId, date) => {
                if(!date) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', lId), { datePlanif: date });
            };

            const ModalReport = () => {
                if (!showReport) return null;
                return h('div', { className: "fixed inset-0 bg-slate-900/95 z-[200] flex flex-col animate-fadeIn" },
                    h('div', { className: "p-6 flex items-center justify-between border-b border-white/10" },
                        h('div', { className: "flex flex-col" },
                            h('h2', { className: "text-white font-black uppercase text-lg tracking-tight" }, "Rapport Journalier"),
                            h('input', { 
                                type: "date", 
                                value: reportDate, 
                                onChange: e => setReportDate(e.target.value),
                                className: "bg-transparent text-slate-400 font-bold outline-none text-[12px] border-none p-0 mt-1"
                            })
                        ),
                        h('button', { onClick: () => setShowReport(false), className: "w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white" }, h(Icon, { name: "close", size: 20 }))
                    ),
                    h('div', { className: "flex-1 overflow-y-auto p-6 space-y-6" },
                        h('div', { className: "grid grid-cols-3 gap-3" },
                            h('div', { className: "bg-emerald-500/10 p-4 rounded-3xl border border-emerald-500/20" }, 
                                h('p', { className: "text-emerald-500 text-[8px] font-black uppercase mb-1" }, "Ventes"),
                                h('p', { className: "text-white font-black text-[14px]" }, `${dayReport.revenue.toLocaleString()} Ar`)
                            ),
                            h('div', { className: "bg-rose-500/10 p-4 rounded-3xl border border-rose-500/20" }, 
                                h('p', { className: "text-rose-500 text-[8px] font-black uppercase mb-1" }, "D√©penses"),
                                h('p', { className: "text-white font-black text-[14px]" }, `${dayReport.expenseTotal.toLocaleString()} Ar`)
                            ),
                            h('div', { className: "bg-indigo-500/10 p-4 rounded-3xl border border-indigo-500/20" }, 
                                h('p', { className: "text-indigo-500 text-[8px] font-black uppercase mb-1" }, "Net"),
                                h('p', { className: "text-white font-black text-[14px]" }, `${dayReport.net.toLocaleString()} Ar`)
                            )
                        ),
                        h('div', { className: "space-y-4" },
                            h('h3', { className: "text-white/40 font-black uppercase text-[10px] tracking-widest" }, `Historique des Ventes (${dayReport.sales.length})`),
                            dayReport.sales.length === 0 ? h('p', { className: "text-white/20 text-center py-10 font-black uppercase" }, "Aucune vente livr√©e") :
                            dayReport.sales.map(s => h('div', { key: s.id, className: "bg-white/5 p-4 rounded-2xl border border-white/5 flex items-center justify-between" },
                                h('div', null,
                                    h('p', { className: "text-white font-black text-[11px] uppercase" }, s.nom),
                                    h('p', { className: "text-slate-500 text-[9px] font-bold" }, s.telephone || "Pas de num√©ro")
                                ),
                                h('p', { className: "text-emerald-400 font-black" }, `${Number(s.montant).toLocaleString()} Ar`)
                            ))
                        )
                    )
                );
            };

            const ModalEdit = () => {
                if (!editingOrder) return null;
                return h('div', { className: "fixed inset-0 bg-black/60 z-[100] flex items-end sm:items-center justify-center p-4 animate-fadeIn" },
                    h('div', { className: "bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 space-y-6 shadow-2xl" },
                        h('h3', { className: "font-black text-center uppercase tracking-widest text-slate-400 text-[10px]" }, "R√©ajustement Livraison"),
                        h('div', { className: "space-y-4" },
                            h('div', null,
                                h('label', { className: "text-[10px] font-black uppercase text-slate-400 mb-1 block" }, "Statut de Livraison"),
                                h('select', { 
                                    value: editingOrder.statut || "En attente", 
                                    onChange: e => setEditingOrder({...editingOrder, statut: e.target.value}),
                                    className: "w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border" 
                                }, ['En attente', 'En cours', 'Livr√©'].map(s => h('option', { key: s, value: s }, s)))
                            ),
                            h('div', null,
                                h('label', { className: "text-[10px] font-black uppercase text-slate-400 mb-1 block" }, "Montant Total"),
                                h('input', { 
                                    type: "number", 
                                    value: editingOrder.montant || 0, 
                                    onChange: e => setEditingOrder({...editingOrder, montant: Number(e.target.value)}),
                                    className: "w-full p-4 bg-slate-50 rounded-2xl font-black text-2xl outline-none border" 
                                })
                            )
                        ),
                        h('div', { className: "flex gap-2" },
                            h('button', { onClick: () => setEditingOrder(null), className: "flex-1 py-4 font-black uppercase text-[10px] text-slate-400" }, "Annuler"),
                            h('button', { 
                                onClick: async () => {
                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', editingOrder.id), { 
                                        montant: Number(editingOrder.montant) || 0,
                                        statut: editingOrder.statut || "En attente"
                                    });
                                    setEditingOrder(null);
                                },
                                className: "flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[10px] shadow-lg"
                            }, "Enregistrer")
                        )
                    )
                );
            };

            if (!db) return h('div', { className: "h-screen flex items-center justify-center font-black" }, "CHARGEMENT...");

            return h('div', { className: "min-h-screen bg-slate-50 pb-24" },
                h(ModalEdit),
                h(ModalReport),
                
                tomorrowCount > 0 && h('div', { 
                    onClick: () => { setActiveTab('livraisons'); setDeliveryFilter('Demain'); },
                    className: "bg-indigo-600 text-white px-4 py-2 flex items-center justify-center gap-2 animate-fadeIn sticky top-0 z-[60] shadow-md cursor-pointer" 
                },
                    h(Icon, { name: "bell", size: 14, className: "animate-bounce" }),
                    h('span', { className: "text-[10px] font-black uppercase tracking-wider" }, 
                        `${tomorrowCount} livraison${tomorrowCount > 1 ? 's' : ''} pr√©vue${tomorrowCount > 1 ? 's' : ''} pour demain !`
                    )
                ),

                h('header', { className: `bg-white px-6 py-4 flex items-center justify-between border-b sticky ${tomorrowCount > 0 ? 'top-[34px]' : 'top-0'} z-50 shadow-sm` },
                    h('div', { className: "flex items-center gap-2" },
                        h('div', { className: "w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white font-black italic shadow-lg" }, "R"),
                        h('span', { className: "font-black text-lg italic uppercase tracking-tighter" }, "Rasoa Pro")
                    ),
                    h('button', { 
                        onClick: () => { setReportDate(new Date().toISOString().split('T')[0]); setShowReport(true); },
                        className: "p-2 bg-slate-100 rounded-full text-slate-900"
                    }, h(Icon, { name: "fileText", size: 18 }))
                ),

                h('main', { className: "max-w-xl mx-auto p-4 space-y-6" },
                    h('nav', { className: "flex gap-2 bg-white p-1 rounded-2xl border shadow-sm" },
                        [
                            {id: 'commandes', label: 'Vente', icon: 'shoppingCart'},
                            {id: 'livraisons', label: 'Suivi', icon: 'truck'},
                            {id: 'clients', label: 'Client', icon: 'users'},
                            {id: 'finances', label: 'Cl√¥ture', icon: 'trendingUp'}
                        ].map(tab => h('button', { 
                            key: tab.id, onClick: () => setActiveTab(tab.id),
                            className: `flex-1 flex flex-col items-center gap-1 py-3 rounded-xl font-black text-[9px] uppercase transition-all ${activeTab === tab.id ? 'tab-active shadow-md' : 'text-slate-400'}`
                        }, h(Icon, { name: tab.icon, size: 14 }), tab.label))
                    ),

                    activeTab === 'commandes' && h('div', { className: "animate-fadeIn" },
                        h('div', { className: "bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100" },
                            h('div', { className: "flex items-center justify-between mb-6" },
                                h('h2', { className: "font-black uppercase text-[11px] tracking-widest text-slate-400" }, "Nouvelle Commande"),
                                h('select', { 
                                    value: orderForm.source, 
                                    onChange: e => setOrderForm({...orderForm, source: e.target.value}),
                                    className: "bg-slate-100 px-3 py-1 rounded-full text-[10px] font-bold outline-none" 
                                }, ['Facebook', 'TikTok', 'Direct'].map(s => h('option', { key: s, value: s }, s)))
                            ),
                            h('div', { className: "space-y-4 relative" },
                                h('input', { 
                                    value: clientSearch, 
                                    onChange: e => { setClientSearch(e.target.value); setOrderForm({...orderForm, nom: e.target.value}); setShowSuggestions(true); },
                                    placeholder: "Nom du client", 
                                    className: "w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border border-transparent focus:border-slate-200" 
                                }),
                                (showSuggestions && clientSearch && clients.filter(c => c.nom?.toLowerCase().includes(clientSearch.toLowerCase())).length > 0) && h('div', { className: "absolute top-20 left-0 right-0 bg-white border rounded-2xl shadow-2xl z-[60]" },
                                    clients.filter(c => c.nom?.toLowerCase().includes(clientSearch.toLowerCase())).slice(0,5).map(c => h('button', {
                                        key: c.id, onClick: () => { 
                                            setOrderForm({...orderForm, nom: c.nom, telephone: c.telephone || "", lieu: c.adresse || ""}); 
                                            setClientSearch(c.nom); 
                                            setShowSuggestions(false); 
                                        },
                                        className: "w-full p-4 text-left border-b last:border-0 hover:bg-slate-50 font-bold flex justify-between items-center"
                                    }, 
                                        h('span', null, c.nom),
                                        h('div', { className: "flex items-center gap-2" },
                                            h('span', { className: "text-[10px] text-slate-400 font-normal" }, c.telephone)
                                        )
                                    ))
                                ),
                                h('input', { value: orderForm.telephone, onChange: e => setOrderForm({...orderForm, telephone: e.target.value}), placeholder: "N¬∞ T√©l√©phone", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" }),
                                h('input', { value: orderForm.lieu, onChange: e => setOrderForm({...orderForm, lieu: e.target.value}), placeholder: "Lieu de livraison", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" }),
                                h('div', { className: "grid grid-cols-2 gap-3" },
                                    h('input', { type: "date", value: orderForm.datePlanif, onChange: e => setOrderForm({...orderForm, datePlanif: e.target.value}), className: "p-4 bg-slate-50 rounded-2xl font-bold outline-none" }),
                                    h('select', { value: orderForm.paiement, onChange: e => setOrderForm({...orderForm, paiement: e.target.value}), className: "p-4 bg-slate-50 rounded-2xl font-bold outline-none" }, ['Paiement sur livraison', 'Avance', 'Pas encore pay√©'].map(p => h('option', { key: p, value: p }, p)))
                                ),
                                h('input', { type: "number", value: orderForm.montant, onChange: e => setOrderForm({...orderForm, montant: e.target.value}), placeholder: "Montant Total Ar", className: "w-full p-5 bg-slate-50 rounded-2xl font-black text-slate-900 text-3xl outline-none" }),
                                h('button', {
                                    onClick: async () => {
                                        if(!orderForm.nom || !orderForm.montant) return;
                                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'livraisons'), { 
                                            ...orderForm, montant: Number(orderForm.montant) || 0, statut: "En attente", timestamp: serverTimestamp() 
                                        });
                                        setOrderForm({ nom: "", telephone: "", montant: "", avance: 0, lieu: "", source: "Facebook", paiement: "Paiement sur livraison", datePlanif: new Date().toISOString().split('T')[0] }); 
                                        setClientSearch("");
                                    },
                                    className: "w-full bg-slate-900 text-white py-5 rounded-3xl font-black uppercase text-[11px] shadow-xl mt-4"
                                }, "Valider la Commande")
                            )
                        )
                    ),

                    activeTab === 'livraisons' && h('div', { className: "space-y-4 animate-fadeIn" },
                        h('div', { className: "flex gap-2 overflow-x-auto pb-2 scrollbar-hide" },
                            ['En attente', 'En cours', 'Livr√©', 'Demain', 'Pas encore pay√©'].map(f => h('button', {
                                key: f, onClick: () => setDeliveryFilter(f),
                                className: `whitespace-nowrap px-4 py-2.5 rounded-full border font-black text-[10px] uppercase transition-all ${deliveryFilter === f ? 'filter-active shadow-md' : 'bg-white text-slate-400 border-slate-100'}`
                            }, f === 'Demain' ? `üî• Demain (${counts[f]})` : `${f} (${counts[f]})`))
                        ),

                        filteredLivraisons.length === 0 ? h('div', { className: "py-20 text-center opacity-20 font-black uppercase tracking-widest text-[10px]" }, "Aucune livraison") :
                        filteredLivraisons.map(l => h('div', { key: l.id, className: "bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col gap-4 relative" },
                            h('div', { className: "flex items-start justify-between" },
                                h('div', { className: "space-y-1" },
                                    h('div', { className: "flex items-center gap-2 flex-wrap" },
                                        h('p', { className: "font-black text-[13px] uppercase" }, l.nom),
                                        l.source === "Facebook" && h('span', { className: "text-[#1877F2]" }, h(Icon, { name: "facebook", size: 14 })),
                                        l.source === "TikTok" && h('span', { className: "text-black" }, h(Icon, { name: "tiktok", size: 14 })),
                                        l.paiement && h('span', { className: `text-[8px] font-black px-2 py-0.5 rounded-full border ${getPaymentColor(l.paiement || "Paiement sur livraison")}` }, l.paiement)
                                    ),
                                    h('p', { className: "font-black text-slate-900 text-lg" }, `${Number(l.montant || 0).toLocaleString()} Ar`),
                                ),
                                h('div', { className: "flex gap-2" },
                                    h('button', { onClick: () => setEditingOrder(l), className: "p-3 bg-slate-50 text-slate-400 rounded-2xl" }, h(Icon, { name: "edit", size: 18 })),
                                    (l.statut === "En attente" || !l.statut) && h('button', { 
                                        onClick: () => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', l.id), { statut: 'En cours' }), 
                                        className: "p-3 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center gap-1" 
                                    }, h(Icon, { name: "arrowRight", size: 18 })),
                                    l.statut === "En cours" && h('button', { 
                                        onClick: () => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', l.id), { statut: 'Livr√©' }), 
                                        className: "p-3 bg-emerald-50 text-emerald-600 rounded-2xl" 
                                    }, h(Icon, { name: "check", size: 18 }))
                                )
                            ),
                            
                            h('div', { className: "grid grid-cols-1 gap-2 pt-3 border-t border-slate-50" },
                                h('div', { className: "flex items-center gap-3 text-slate-500" },
                                    h(Icon, { name: "mapPin", size: 14, className: "shrink-0" }),
                                    h('span', { className: "font-bold text-[11px]" }, l.lieu || "Non pr√©cis√©")
                                ),
                                h('div', { className: "flex items-center gap-3 text-slate-500" },
                                    h(Icon, { name: "phone", size: 14, className: "shrink-0 text-emerald-500" }),
                                    h('a', { href: `tel:${l.telephone}`, className: "font-black text-[12px] text-slate-900" }, l.telephone || "---")
                                ),
                                h('div', { className: "flex flex-wrap gap-2 mt-2 py-2" },
                                    h('button', { onClick: () => handleReportTomorrow(l.id), className: "flex items-center gap-1.5 px-3 py-2 bg-indigo-50 text-indigo-700 rounded-xl font-black text-[9px] uppercase border border-indigo-100" }, h(Icon, { name: "refresh", size: 12 }), "Reporter"),
                                    h('div', { className: "flex items-center gap-1.5 px-3 py-2 bg-slate-50 text-slate-600 rounded-xl border border-slate-100" }, h(Icon, { name: "calendar", size: 12 }), h('input', { type: "date", onChange: (e) => handleCustomDate(l.id, e.target.value), className: "bg-transparent font-black text-[9px] uppercase outline-none w-20" })),
                                    h('button', { onClick: () => { if(confirm("Supprimer?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', l.id)) }, className: "flex items-center gap-1.5 px-3 py-2 bg-rose-50 text-rose-600 rounded-xl font-black text-[9px] uppercase border border-rose-100 ml-auto" }, h(Icon, { name: "trash", size: 12 }))
                                )
                            )
                        ))
                    ),

                    activeTab === 'clients' && h('div', { className: "space-y-6 animate-fadeIn" },
                        h('div', { className: "bg-white p-6 rounded-[2rem] border shadow-xl" },
                            h('h3', { className: "font-black uppercase text-[11px] mb-4 text-slate-900 tracking-widest" }, "Nouveau Client"),
                            h('div', { className: "space-y-4" },
                                h('input', { value: clientForm.nom, onChange: e => setClientForm({...clientForm, nom: e.target.value}), placeholder: "Nom du client", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border border-transparent focus:border-slate-200" }),
                                h('input', { value: clientForm.telephone, onChange: e => setClientForm({...clientForm, telephone: e.target.value}), placeholder: "N¬∞ T√©l√©phone", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border border-transparent focus:border-slate-200" }),
                                h('input', { value: clientForm.adresse, onChange: e => setClientForm({...clientForm, adresse: e.target.value}), placeholder: "Quartier", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border border-transparent focus:border-slate-200" }),
                                h('button', {
                                    onClick: async () => {
                                        if(!clientForm.nom) return;
                                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), { ...clientForm, timestamp: serverTimestamp() });
                                        setClientForm({ nom: "", telephone: "", adresse: "", source: "Facebook" });
                                    },
                                    className: "w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[11px]"
                                }, "Sauvegarder Client")
                            )
                        ),
                        h('div', { className: "space-y-3" },
                            clients.map(c => h('div', { key: c.id, className: "bg-white p-5 rounded-3xl border shadow-sm flex items-start gap-4" },
                                h('div', { className: `p-3 rounded-2xl bg-blue-50 text-blue-600` }, h(Icon, { name: "users", size: 18 })),
                                h('div', { className: "flex-1" },
                                    h('div', { className: "flex items-center justify-between" },
                                        h('p', { className: "font-black text-slate-900 uppercase text-[12px]" }, c.nom),
                                        h('button', { onClick: () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', c.id)), className: "text-slate-200 hover:text-rose-500" }, h(Icon, { name: "trash", size: 14 }))
                                    ),
                                    h('p', { className: "text-slate-500 text-[10px] font-bold" }, `${c.telephone || '---'} | ${c.adresse || '---'}`)
                                )
                            ))
                        )
                    ),

                    activeTab === 'finances' && h('div', { className: "space-y-6 animate-fadeIn" },
                        h('div', { className: "bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden" },
                            h('div', { className: "absolute top-0 right-0 p-6 opacity-10" }, h(Icon, { name: "trendingUp", size: 120 })),
                            h('p', { className: "text-[10px] font-black uppercase opacity-60 mb-1" }, "Recette Totale Nette"),
                            h('p', { className: "text-4xl font-black tracking-tighter" }, `${stats.net.toLocaleString()} Ar`),
                            h('div', { className: "flex gap-4 mt-6 border-t border-white/10 pt-6" },
                                h('div', { className: "flex-1" }, h('p', { className: "text-[8px] font-bold opacity-50 uppercase" }, "Ventes cumul√©es"), h('p', { className: "font-black" }, `${stats.encaisse.toLocaleString()} Ar`)),
                                h('div', { className: "flex-1" }, h('p', { className: "text-[8px] font-bold opacity-50 uppercase" }, "D√©penses cumul√©es"), h('p', { className: "font-black text-rose-400" }, `${stats.charges.toLocaleString()} Ar`))
                            )
                        ),

                        h('button', { 
                            onClick: () => { setReportDate(new Date().toISOString().split('T')[0]); setShowReport(true); },
                            className: "w-full p-6 bg-white rounded-[2rem] border shadow-sm flex items-center justify-between group active:scale-95 transition-all"
                        },
                            h('div', { className: "flex items-center gap-4" },
                                h('div', { className: "w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center" }, h(Icon, { name: "fileText", size: 24 })),
                                h('div', { className: "text-left" },
                                    h('p', { className: "font-black uppercase text-[12px] text-slate-900" }, "Rapports Journaliers"),
                                    h('p', { className: "text-[10px] font-bold text-slate-400" }, "Voir historique et statistiques par date")
                                )
                            ),
                            h(Icon, { name: "chevronRight", size: 20, className: "text-slate-300 group-hover:translate-x-1 transition-transform" })
                        ),

                        h('div', { className: "bg-white p-6 rounded-[2rem] border border-rose-100 shadow-sm" },
                            h('h3', { className: "font-black uppercase text-[11px] mb-4 text-rose-600" }, "Nouvelle D√©pense"),
                            h('div', { className: "space-y-3" },
                                h('input', { type: "date", value: expenseForm.date, onChange: e => setExpenseForm({...expenseForm, date: e.target.value}), className: "w-full p-3 bg-slate-50 rounded-xl font-bold border" }),
                                h('input', { value: expenseForm.titre, onChange: e => setExpenseForm({...expenseForm, titre: e.target.value}), placeholder: "Motif", className: "w-full p-3 bg-slate-50 rounded-xl font-bold border" }),
                                h('input', { type: "number", value: expenseForm.montant, onChange: e => setExpenseForm({...expenseForm, montant: e.target.value}), placeholder: "Montant Ar", className: "w-full p-3 bg-slate-50 rounded-xl font-bold border" }),
                                h('button', {
                                    onClick: async () => {
                                        if(!expenseForm.titre || !expenseForm.montant) return;
                                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'depenses'), { 
                                            ...expenseForm, montant: Number(expenseForm.montant) || 0, timestamp: serverTimestamp() 
                                        });
                                        setExpenseForm({ titre: "", montant: "", date: new Date().toISOString().split('T')[0] });
                                    },
                                    className: "w-full bg-rose-600 text-white py-4 rounded-xl font-black uppercase text-[9px]"
                                }, "Enregistrer D√©pense")
                            )
                        ),

                        // Liste des d√©penses avec option de suppression
                        h('div', { className: "space-y-4" },
                            h('h3', { className: "font-black uppercase text-[10px] text-slate-400 tracking-widest" }, "Historique des d√©penses"),
                            depenses.length === 0 ? h('p', { className: "text-center py-10 opacity-20 font-black" }, "AUCUNE D√âPENSE") :
                            depenses.sort((a,b) => b.date.localeCompare(a.date)).map(d => h('div', { key: d.id, className: "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between animate-fadeIn" },
                                h('div', { className: "flex flex-col" },
                                    h('p', { className: "text-[10px] font-black text-rose-500 uppercase" }, d.date),
                                    h('p', { className: "font-bold text-slate-900" }, d.titre)
                                ),
                                h('div', { className: "flex items-center gap-4" },
                                    h('p', { className: "font-black text-rose-600" }, `-${Number(d.montant).toLocaleString()} Ar`),
                                    h('button', { 
                                        onClick: () => { if(confirm("Supprimer cette d√©pense ?")) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'depenses', d.id)) },
                                        className: "p-2 text-slate-200 hover:text-rose-600 transition-colors" 
                                    }, h(Icon, { name: "trash", size: 16 }))
                                )
                            ))
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(App));
    </script>
</body>
</html>
