<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasoa Pro V9.1 - Dates de Livraison</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 text-[13px] md:text-[14px]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const { useState, useEffect, useMemo, createElement: h } = React;

        const firebaseConfig = {
            apiKey: "",
            authDomain: "rasoa-pro.firebaseapp.com",
            projectId: "rasoa-pro",
            storageBucket: "rasoa-pro.firebasestorage.app",
            messagingSenderId: "344947402269",
            appId: "1:344947402269:web:76dfee1a27e780e80ac8f4"
        };
        const appId = "rasoa-pro-v4"; 

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                shoppingCart: [h('path', { key: '1', d: "M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" }), h('path', { key: '2', d: "M3 6h18" }), h('path', { key: '3', d: "M16 10a4 4 0 0 1-8 0" })],
                users: [h('path', { key: '1', d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }), h('circle', { key: '2', cx: "9", cy: "7", r: "4" }), h('path', { key: '3', d: "M22 21v-2a4 4 0 0 0-3-3.87" }), h('path', { key: '4', d: "M16 3.13a4 4 0 0 1 0 7.75" })],
                trendingUp: [h('polyline', { key: '1', points: "22 7 13.5 15.5 8.5 10.5 2 17" }), h('polyline', { key: '2', points: "16 7 22 7 22 13" })],
                fileText: [h('path', { key: '1', d: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" }), h('polyline', { key: '2', points: "14 2 14 8 20 8" })],
                mapPin: [h('path', { key: '1', d: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" }), h('circle', { key: '2', cx: "12", cy: "10", r: "3" })],
                calendar: [h('rect', { key: '1', x: "3", y: "4", width: "18", height: "18", rx: "2", ry: "2" }), h('line', { key: '2', x1: "16", y1: "2", x2: "16", y2: "6" }), h('line', { key: '3', x1: "8", y1: "2", x2: "8", y2: "6" }), h('line', { key: '4', x1: "3", y1: "10", x2: "21", y2: "10" })],
                trash: [h('polyline', { key: '1', points: "3 6 5 6 21 6" }), h('path', { key: '2', d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" })],
                search: [h('circle', { key: '1', cx: "11", cy: "11", r: "8" }), h('line', { key: '2', x1: "21", y1: "21", x2: "16.65", y2: "16.65" })],
                bell: [h('path', { key: '1', d: "M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" }), h('path', { key: '2', d: "M13.73 21a2 2 0 0 1-3.46 0" })],
                chevronRight: [h('polyline', { key: '1', points: "9 18 15 12 9 6" })]
            };
            return h('svg', { width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2.5", strokeLinecap: "round", strokeLinejoin: "round", className: className }, icons[name] || null);
        };

        function App() {
            const [db, setDb] = useState(null);
            const [activeTab, setActiveTab] = useState("commandes");
            const [livraisons, setLivraisons] = useState([]);
            const [depenses, setDepenses] = useState([]);
            const [deliveryFilter, setDeliveryFilter] = useState("Aujourd'hui");
            const [clientSearch, setClientSearch] = useState("");
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [suggestedClients, setSuggestedClients] = useState([]);

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            const [orderForm, setOrderForm] = useState({ 
                nom: "", telephone: "", lieu: "", montant: "", avance: "", typePaiement: "Avance", datePlanif: todayStr 
            });

            const [depenseForm, setDepenseForm] = useState({ libelle: "", montant: "", categorie: "Achat" });

            useEffect(() => {
                const app = initializeApp(firebaseConfig);
                setDb(getFirestore(app));
            }, []);

            useEffect(() => {
                if (!db) return;
                const livRef = collection(db, 'artifacts', appId, 'public', 'data', 'livraisons');
                const depRef = collection(db, 'artifacts', appId, 'public', 'data', 'depenses');

                const unsubLiv = onSnapshot(query(livRef, orderBy('timestamp', 'desc')), s => {
                    setLivraisons(s.docs.map(d => ({id: d.id, ...d.data()})));
                }, (err) => console.error(err));
                const unsubDep = onSnapshot(query(depRef, orderBy('timestamp', 'desc')), s => {
                    setDepenses(s.docs.map(d => ({id: d.id, ...d.data()})));
                }, (err) => console.error(err));

                return () => { unsubLiv(); unsubDep(); };
            }, [db]);

            const alerts = useMemo(() => {
                const tomorrowCount = livraisons.filter(l => l.datePlanif === tomorrowStr && l.statut !== 'Livré').length;
                const lateCount = livraisons.filter(l => l.datePlanif <= todayStr && l.statut !== 'Livré').length;
                return { tomorrowCount, lateCount };
            }, [livraisons, tomorrowStr, todayStr]);

            const filterCounts = useMemo(() => {
                return {
                    "Aujourd'hui": livraisons.filter(l => l.datePlanif === todayStr && l.statut !== 'Livré').length,
                    "Demain": alerts.tomorrowCount,
                    "Retards": alerts.lateCount,
                    "En attente": livraisons.filter(l => l.statut === "En attente").length,
                    "Livré": livraisons.filter(l => l.statut === "Livré").length
                };
            }, [livraisons, todayStr, alerts]);

            const clientsListe = useMemo(() => {
                const map = new Map();
                livraisons.forEach(l => {
                    const key = (l.telephone || l.nom).toLowerCase();
                    if (!map.has(key)) map.set(key, { nom: l.nom, telephone: l.telephone || "", lieu: l.lieu || "Non précisé", totalVentes: 0, historique: [] });
                    const c = map.get(key);
                    c.totalVentes += (Number(l.montant) || 0);
                    if (l.lieu) c.lieu = l.lieu;
                    c.historique.push(l);
                });
                return Array.from(map.values()).sort((a,b) => b.totalVentes - a.totalVentes);
            }, [livraisons]);

            const stats = useMemo(() => {
                const caReel = livraisons.filter(l => l.statut === "Livré").reduce((acc, l) => acc + (Number(l.montant) || 0), 0);
                const caPrevu = livraisons.reduce((acc, l) => acc + (Number(l.montant) || 0), 0);
                const totalDepenses = depenses.reduce((acc, d) => acc + (Number(d.montant) || 0), 0);
                const resteAEncaisser = livraisons.filter(l => l.statut !== "Livré").reduce((acc, l) => acc + ((Number(l.montant) || 0) - (Number(l.avance) || 0)), 0);
                return { caReel, caPrevu, totalDepenses, benefice: caReel - totalDepenses, resteAEncaisser };
            }, [livraisons, depenses]);

            const handleAddOrder = async () => {
                if(!orderForm.nom || !orderForm.montant) return;
                const mnt = Number(orderForm.montant) || 0;
                const av = orderForm.typePaiement === "Total" ? mnt : (Number(orderForm.avance) || 0);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'livraisons'), { 
                    ...orderForm, montant: mnt, avance: av, statut: "En attente", timestamp: serverTimestamp() 
                });
                setOrderForm({ nom: "", telephone: "", lieu: "", montant: "", avance: "", typePaiement: "Avance", datePlanif: todayStr });
                setShowSuggestions(false);
            };

            const filteredLivraisons = useMemo(() => {
                if (deliveryFilter === "Aujourd'hui") return livraisons.filter(l => l.datePlanif === todayStr && l.statut !== 'Livré');
                if (deliveryFilter === "Demain") return livraisons.filter(l => l.datePlanif === tomorrowStr && l.statut !== 'Livré');
                if (deliveryFilter === "Retards") return livraisons.filter(l => l.datePlanif <= todayStr && l.statut !== 'Livré');
                if (deliveryFilter === "En attente") return livraisons.filter(l => l.statut === "En attente");
                return livraisons.filter(l => l.statut === deliveryFilter);
            }, [livraisons, deliveryFilter, todayStr, tomorrowStr]);

            const formatDate = (dateStr) => {
                if(!dateStr) return "";
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            };

            if (!db) return h('div', { className: "h-screen flex items-center justify-center font-black animate-pulse text-indigo-600" }, "CHARGEMENT...");

            return h('div', { className: "min-h-screen pb-24" },
                h('header', { className: "bg-white border-b px-6 py-4 flex items-center justify-between sticky top-0 z-[100] shadow-sm" },
                    h('div', { className: "flex items-center gap-3" },
                        h('div', { className: "w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black italic shadow-lg" }, "R"),
                        h('h1', { className: "font-black text-xl italic leading-none" }, "RASOA PRO")
                    ),
                    h('div', { className: "text-right" },
                        h('p', { className: "text-[10px] font-black text-slate-400 uppercase" }, "Reste à encaisser"),
                        h('p', { className: "font-black text-rose-500" }, `${stats.resteAEncaisser.toLocaleString()} Ar`)
                    )
                ),

                h('main', { className: "max-w-7xl mx-auto p-4 lg:p-8" },
                    
                    activeTab === 'commandes' && h('div', { className: "space-y-6 animate-fadeIn" }, [
                        
                        // SECTION ALERTES AVEC FILTRAGE
                        (alerts.tomorrowCount > 0 || alerts.lateCount > 0) && h('div', { key: 'alert-zone', className: "flex gap-4 overflow-x-auto pb-2 scrollbar-hide" }, [
                            alerts.lateCount > 0 && h('div', { key: 'late', onClick: () => setDeliveryFilter("Retards"), className: "cursor-pointer group flex-shrink-0 bg-rose-50 border border-rose-100 p-4 rounded-3xl flex items-center gap-4 transition-all hover:bg-rose-100" }, [
                                h('div', {className:"w-10 h-10 bg-rose-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-rose-200"}, h(Icon, {name:"bell", size:20})),
                                h('div', {}, [
                                    h('p', {className:"text-[10px] font-black text-rose-400 uppercase"}, "Retard / Aujourd'hui"),
                                    h('div', {className:"flex items-center gap-2"}, [
                                        h('p', {className:"font-black text-rose-600"}, `${alerts.lateCount} livraison(s)`),
                                        h('div', {className:"bg-rose-600 text-white text-[9px] px-2 py-0.5 rounded-full flex items-center gap-1"}, ["VOIR", h(Icon, {name:"chevronRight", size:8})])
                                    ])
                                ])
                            ]),
                            alerts.tomorrowCount > 0 && h('div', { key: 'tmw', onClick: () => setDeliveryFilter("Demain"), className: "cursor-pointer group flex-shrink-0 bg-indigo-50 border border-indigo-100 p-4 rounded-3xl flex items-center gap-4 transition-all hover:bg-indigo-100" }, [
                                h('div', {className:"w-10 h-10 bg-indigo-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-200"}, h(Icon, {name:"shoppingCart", size:20})),
                                h('div', {}, [
                                    h('p', {className:"text-[10px] font-black text-indigo-400 uppercase"}, "Prévu Demain (J+1)"),
                                    h('div', {className:"flex items-center gap-2"}, [
                                        h('p', {className:"font-black text-indigo-600"}, `${alerts.tomorrowCount} commande(s)`),
                                        h('div', {className:"bg-indigo-600 text-white text-[9px] px-2 py-0.5 rounded-full flex items-center gap-1"}, ["VOIR", h(Icon, {name:"chevronRight", size:8})])
                                    ])
                                ])
                            ])
                        ]),

                        h('div', { key: 'main-grid', className: "grid lg:grid-cols-3 gap-8" }, [
                            h('div', { key: 'form-col', className: "lg:col-span-1" },
                                h('div', { className: "bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 sticky top-[100px]" },
                                    h('h2', { className: "font-black uppercase text-[11px] tracking-widest text-slate-400 mb-6" }, "Nouvelle Commande"),
                                    h('div', { className: "space-y-4 relative" },
                                        h('div', { className: "relative" },
                                            h('input', { value: orderForm.nom, onChange: e => { setOrderForm(p=>({...p, nom: e.target.value})); if(e.target.value.trim()){const f=clientsListe.filter(c=>c.nom.toLowerCase().includes(e.target.value.toLowerCase())).slice(0,5); setSuggestedClients(f); setShowSuggestions(f.length>0);}else setShowSuggestions(false); }, placeholder: "Nom client", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold border outline-none focus:border-indigo-600 shadow-inner" }),
                                            showSuggestions && h('div', { className: "absolute top-full left-0 right-0 bg-white border rounded-2xl mt-2 shadow-2xl z-50 overflow-hidden" },
                                                suggestedClients.map((c, i) => h('button', { key: i, onClick: () => { setOrderForm(p => ({...p, nom: c.nom, telephone: c.telephone, lieu: c.lieu})); setShowSuggestions(false); }, className: "w-full p-4 text-left hover:bg-indigo-50 border-b last:border-0" }, [
                                                    h('p', { key: 'n', className: "font-black" }, c.nom), h('p', { key: 't', className: "text-[10px] text-indigo-500 font-bold" }, c.telephone)
                                                ]))
                                            )
                                        ),
                                        h('input', { value: orderForm.telephone, onChange: e => setOrderForm({...orderForm, telephone: e.target.value}), placeholder: "Téléphone", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold border outline-none" }),
                                        h('input', { value: orderForm.lieu, onChange: e => setOrderForm({...orderForm, lieu: e.target.value}), placeholder: "Lieu de livraison", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold border outline-none" }),
                                        h('div', { className: "grid grid-cols-2 gap-3" }, [
                                            h('input', { key: 'd', type: "date", value: orderForm.datePlanif, onChange: e => setOrderForm({...orderForm, datePlanif: e.target.value}), className: "p-4 bg-slate-50 rounded-2xl font-bold border outline-none text-xs" }),
                                            h('input', { key: 'm', type: "number", value: orderForm.montant, onChange: e => setOrderForm({...orderForm, montant: e.target.value}), placeholder: "Prix Total", className: "p-4 bg-indigo-50 rounded-2xl font-black border border-indigo-100 outline-none text-indigo-600" })
                                        ]),
                                        h('div', { className: "flex p-1 bg-slate-100 rounded-2xl" },
                                            ['Avance', 'Total'].map(type => h('button', { key: type, onClick: () => setOrderForm({...orderForm, typePaiement: type, avance: type === 'Total' ? orderForm.montant : ""}), className: `flex-1 py-2 rounded-xl font-black text-[10px] uppercase transition-all ${orderForm.typePaiement === type ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}` }, type))
                                        ),
                                        orderForm.typePaiement === 'Avance' && h('input', { type: "number", value: orderForm.avance, onChange: e => setOrderForm({...orderForm, avance: e.target.value}), placeholder: "Montant Avancé", className: "w-full p-4 bg-orange-50 rounded-2xl font-black border border-orange-100 outline-none text-orange-600" }),
                                        h('button', { onClick: handleAddOrder, className: "w-full bg-indigo-600 text-white py-5 rounded-3xl font-black uppercase text-[11px] shadow-lg hover:bg-indigo-700 active:scale-95 transition-all" }, "Enregistrer la vente")
                                    )
                                )
                            ),
                            h('div', { key: 'list-col', className: "lg:col-span-2 space-y-6" }, [
                                h('div', { key: 'f', className: "flex gap-2 overflow-x-auto pb-2 scrollbar-hide sticky top-[80px] z-40 bg-slate-50/90 py-2 backdrop-blur-sm" }, 
                                    Object.keys(filterCounts).map(f => h('button', { key: f, onClick: () => setDeliveryFilter(f), className: `flex items-center gap-2 px-5 py-3 rounded-full border font-black text-[10px] uppercase transition-all whitespace-nowrap ${deliveryFilter === f ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-400 border-slate-200'}` }, [
                                        f, 
                                        h('span', { className: `px-1.5 py-0.5 rounded-md text-[9px] ${deliveryFilter === f ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-500'}` }, filterCounts[f])
                                    ]))
                                ),
                                h('div', { key: 'l', className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, 
                                    filteredLivraisons.map(l => h('div', { key: l.id, className: "bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm animate-fadeIn" }, [
                                        h('div', { key: 'h', className: "flex justify-between items-start" }, [
                                            h('div', { key: 'i' }, [
                                                h('p', {key:'n', className:"font-black uppercase text-slate-900"}, l.nom), 
                                                h('p', {key:'t', className:"text-indigo-500 font-bold text-[10px] mb-2"}, l.telephone),
                                                h('div', {key:'l', className:"flex items-center gap-1 text-slate-400 mb-1"}, [h(Icon, {name:"mapPin", size:10}), h('span', {className:"text-[10px] font-bold"}, l.lieu || "Lieu non défini")]),
                                                h('div', {key:'dt', className:"flex items-center gap-1 text-indigo-400 font-black text-[9px] uppercase"}, [h(Icon, {name:"calendar", size:10}), formatDate(l.datePlanif)])
                                            ]),
                                            h('div', {key:'st', className:`px-3 py-1 rounded-full text-[8px] font-black uppercase h-fit ${l.statut === 'Livré' ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-100 text-orange-600'}`}, l.statut)
                                        ]),
                                        h('div', { key: 's', className: "flex justify-between border-t border-slate-50 mt-4 pt-4" }, [
                                            h('div', { key: 't' }, [h('p', {className:"text-[8px] font-black text-slate-400 uppercase"}, "Montant"), h('p', {className:"font-black text-slate-900"}, `${(Number(l.montant)||0).toLocaleString()} Ar`)]),
                                            h('div', { key: 'r' }, [h('p', {className:"text-[8px] font-black text-rose-400 uppercase"}, "Reste"), h('p', {className:"font-black text-rose-600"}, `${((Number(l.montant)||0) - (Number(l.avance)||0)).toLocaleString()} Ar`)])
                                        ]),
                                        l.statut !== "Livré" && h('button', { key: 'b', onClick: () => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', l.id), { statut: 'Livré', avance: l.montant }), className: "w-full mt-4 bg-emerald-500 text-white py-3 rounded-2xl font-black uppercase text-[10px] shadow-lg shadow-emerald-100" }, "Confirmer Livraison")
                                    ]))
                                )
                            ])
                        ])
                    ]),

                    // ONGLET CLIENTS
                    activeTab === 'clients' && h('div', { className: "space-y-6 animate-fadeIn" }, [
                        h('div', { className: "bg-white p-6 rounded-[2.5rem] shadow-sm border flex items-center gap-4" }, [
                            h(Icon, { name: "search", className: "text-slate-400" }),
                            h('input', { value: clientSearch, onChange: e => setClientSearch(e.target.value), placeholder: "Rechercher par nom, tel ou lieu...", className: "w-full bg-transparent font-bold outline-none text-lg" })
                        ]),
                        h('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" }, 
                            clientsListe.filter(c => 
                                c.nom.toLowerCase().includes(clientSearch.toLowerCase()) || 
                                c.telephone.includes(clientSearch) || 
                                c.lieu.toLowerCase().includes(clientSearch.toLowerCase())
                            ).map((c, i) => h('div', { key: i, className: "bg-white p-8 rounded-[3rem] border shadow-sm flex flex-col items-center text-center hover:border-indigo-200 transition-all" }, [
                                h('div', { key: 'av', className: "w-16 h-16 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mb-4 font-black text-xl uppercase border-2 border-white shadow-md" }, c.nom[0]),
                                h('p', { key: 'n', className: "font-black text-xl leading-tight mb-1" }, c.nom),
                                h('p', { key: 't', className: "text-indigo-500 font-bold text-sm mb-1" }, c.telephone),
                                h('p', { key: 'l', className: "text-slate-400 text-[10px] font-bold uppercase mb-4 flex items-center gap-1" }, [h(Icon, {name:"mapPin", size:10}), c.lieu]),
                                h('div', { key: 's', className: "w-full grid grid-cols-2 gap-2 mb-6" }, [
                                    h('div', { key: 'v', className: "bg-slate-50 p-3 rounded-2xl border border-slate-100" }, [h('p', {className:"text-[8px] font-black uppercase text-slate-400 mb-1"}, "Volume Total"), h('p', {className:"font-black text-[12px] text-slate-900"}, `${c.totalVentes.toLocaleString()} Ar`)]),
                                    h('div', { key: 'c', className: "bg-slate-50 p-3 rounded-2xl border border-slate-100" }, [h('p', {className:"text-[8px] font-black uppercase text-slate-400 mb-1"}, "Commandes"), h('p', {className:"font-black text-[12px] text-slate-900"}, c.historique.length)])
                                ]),
                                h('button', { key: 'b', onClick: () => { setOrderForm({...orderForm, nom: c.nom, telephone: c.telephone, lieu: c.lieu}); setActiveTab('commandes'); }, className: "w-full bg-slate-900 text-white py-3 rounded-2xl font-black uppercase text-[9px] hover:bg-indigo-600 transition-all shadow-lg" }, "Nouvelle Commande")
                            ]))
                        )
                    ]),

                    // ONGLET DEPENSES
                    activeTab === 'finances' && h('div', { className: "grid lg:grid-cols-3 gap-8 animate-fadeIn" }, [
                        h('div', { className: "lg:col-span-1" },
                            h('div', { className: "bg-white p-8 rounded-[2.5rem] border shadow-xl sticky top-[100px]" }, [
                                h('h2', { key: 'h', className: "font-black uppercase text-[11px] text-slate-400 mb-6" }, "Nouvelle Dépense"),
                                h('div', { key: 'f', className: "space-y-4" }, [
                                    h('input', { key: 'l', value: depenseForm.libelle, onChange: e => setDepenseForm({...depenseForm, libelle: e.target.value}), placeholder: "Ex: Loyer, Grossiste...", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold border outline-none shadow-inner" }),
                                    h('input', { key: 'm', type: "number", value: depenseForm.montant, onChange: e => setDepenseForm({...depenseForm, montant: e.target.value}), placeholder: "Montant Ar", className: "w-full p-4 bg-rose-50 rounded-2xl font-black border border-rose-100 outline-none text-rose-600" }),
                                    h('select', { key: 'c', value: depenseForm.categorie, onChange: e => setDepenseForm({...depenseForm, categorie: e.target.value}), className: "w-full p-4 bg-slate-50 rounded-2xl font-bold border outline-none" }, 
                                        ['Stock / Achat', 'Loyer', 'Salaires', 'Transport', 'Publicité / FB', 'Autre'].map(cat => h('option', { key: cat, value: cat }, cat))
                                    ),
                                    h('button', { key: 'b', onClick: async () => { if(!depenseForm.libelle || !depenseForm.montant) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'depenses'), {...depenseForm, montant:Number(depenseForm.montant), timestamp:serverTimestamp()}); setDepenseForm({libelle:"", montant:"", categorie:"Achat"}); }, className: "w-full bg-rose-500 text-white py-5 rounded-3xl font-black uppercase text-[11px] shadow-lg hover:bg-rose-600 active:scale-95 transition-all" }, "Enregistrer Dépense")
                                ])
                            ])
                        ),
                        h('div', { className: "lg:col-span-2 space-y-4" }, 
                            depenses.map(d => h('div', { key: d.id, className: "bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center justify-between animate-fadeIn" }, [
                                h('div', { key: 'i' }, [
                                    h('p', { key: 'l', className: "font-black text-slate-900" }, d.libelle),
                                    h('span', { key: 'c', className: "text-[9px] font-black uppercase bg-slate-100 px-2 py-1 rounded text-slate-500" }, d.categorie)
                                ]),
                                h('div', { key: 'r', className: "flex items-center gap-4" }, [
                                    h('p', { key: 'm', className: "font-black text-rose-600" }, `-${(Number(d.montant)).toLocaleString()} Ar`),
                                    h('button', { key: 'd', onClick: () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'depenses', d.id)), className: "p-2 text-slate-300 hover:text-rose-500" }, h(Icon, { name: "trash", size: 16 }))
                                ])
                            ]))
                        )
                    ]),

                    // ONGLET RAPPORTS
                    activeTab === 'rapports' && h('div', { className: "space-y-8 animate-fadeIn" }, [
                        h('div', { key: 'sum', className: "grid grid-cols-1 md:grid-cols-4 gap-6" }, [
                            h('div', { key: 'ca-r', className: "bg-emerald-500 p-8 rounded-[3rem] text-white shadow-xl shadow-emerald-100" }, [
                                h('p', {className:"text-[10px] font-black uppercase opacity-70 mb-2"}, "CA Réel (Livré)"), 
                                h('p', {className:"text-2xl font-black leading-none"}, `${stats.caReel.toLocaleString()} Ar`)
                            ]),
                            h('div', { key: 'ca-p', className: "bg-indigo-600 p-8 rounded-[3rem] text-white shadow-xl shadow-indigo-100" }, [
                                h('p', {className:"text-[10px] font-black uppercase opacity-70 mb-2"}, "CA Prévisionnel"), 
                                h('p', {className:"text-2xl font-black leading-none"}, `${stats.caPrevu.toLocaleString()} Ar`)
                            ]),
                            h('div', { key: 'dep', className: "bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm" }, [
                                h('p', {className:"text-[10px] font-black uppercase text-slate-400 mb-2"}, "Dépenses Totales"), 
                                h('p', {className:"text-2xl font-black text-rose-500 leading-none"}, `${stats.totalDepenses.toLocaleString()} Ar`)
                            ]),
                            h('div', { key: 'ben', className: "bg-slate-900 p-8 rounded-[3rem] text-white shadow-xl shadow-slate-200" }, [
                                h('p', {className:"text-[10px] font-black uppercase opacity-70 mb-2"}, "Bénéfice Net"), 
                                h('p', {className:"text-2xl font-black leading-none"}, `${stats.benefice.toLocaleString()} Ar`)
                            ])
                        ])
                    ])
                ),

                h('nav', { className: "fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t p-3 flex gap-1 z-[150] shadow-2xl" },
                    [
                        {id: 'commandes', label: 'Ventes', icon: 'shoppingCart'},
                        {id: 'clients', label: 'Clients', icon: 'users'},
                        {id: 'finances', label: 'Dépenses', icon: 'trendingUp'},
                        {id: 'rapports', label: 'Rapports', icon: 'fileText'}
                    ].map(tab => h('button', { 
                        key: tab.id, onClick: () => setActiveTab(tab.id),
                        className: `flex-1 py-3 flex flex-col items-center gap-1 rounded-2xl font-black text-[8px] uppercase transition-all ${activeTab === tab.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-400 hover:text-indigo-400'}`
                    }, [
                        h(Icon, { key: 'ico', name: tab.icon, size: 18 }), 
                        tab.label
                    ]))
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(App));
    </script>
</body>
</html>
