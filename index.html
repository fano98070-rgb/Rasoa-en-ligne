<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasoa Pro - Gestion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Touche cachée modifiée pour être plus repérable lors du test */
        .hidden-trigger { 
            opacity: 0.1; 
            transition: all 0.3s; 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        .hidden-trigger:hover { 
            opacity: 1; 
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <!-- Écran de Connexion -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-4">
        
        <!-- BOUTON CACHÉ (Flèche en haut à droite) -->
        <button id="backdoor-btn" class="hidden-trigger absolute top-6 right-6 text-white p-4 cursor-pointer flex flex-col items-center gap-1">
            <i data-lucide="chevron-up" class="w-6 h-6"></i>
            <span class="text-[8px] uppercase font-bold tracking-widest">Admin</span>
        </button>

        <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-sm text-center shadow-2xl relative">
            <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h1 class="text-2xl font-black mb-2 uppercase tracking-tight text-slate-900">Rasoa Pro</h1>
            <p class="text-slate-500 text-sm mb-8 font-medium">Espace de gestion réservé</p>
            
            <div class="space-y-4">
                <input type="password" id="admin-password" placeholder="Mot de passe" 
                    class="w-full p-4 bg-slate-50 border rounded-2xl text-center font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center gap-2">
                    <span>Connexion</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
            <p id="login-error" class="text-rose-500 text-xs mt-4 font-bold hidden uppercase tracking-widest">Mot de passe incorrect</p>
        </div>
    </div>

    <!-- Application Principale -->
    <div id="app-content" class="hidden">
        <nav class="bg-white border-b px-6 h-16 flex items-center justify-between sticky top-0 z-50 shadow-sm">
            <div class="flex items-center gap-2 font-black text-xl tracking-tighter uppercase text-indigo-600">
                <i data-lucide="zap" class="fill-current w-5 h-5"></i> Rasoa Pro
            </div>
            <button id="logout-btn" class="text-slate-400 font-bold text-sm flex items-center gap-1 px-4 py-2 rounded-xl hover:bg-slate-100 transition-colors">
                <i data-lucide="log-out" class="w-4 h-4"></i> Quitter
            </button>
        </nav>

        <div class="bg-white border-b overflow-x-auto sticky top-16 z-40 no-scrollbar">
            <div class="max-w-5xl mx-auto px-4 flex">
                <button data-tab="vente" class="tab-btn active px-6 py-4 flex items-center gap-2 border-b-2 font-bold text-sm whitespace-nowrap transition-all border-indigo-600 text-indigo-600 bg-indigo-50/30">
                    <i data-lucide="shopping-cart" class="w-4 h-4"></i> Vente
                </button>
                <button data-tab="livraisons" class="tab-btn px-6 py-4 flex items-center gap-2 border-b-2 font-bold text-sm whitespace-nowrap transition-all border-transparent text-slate-400">
                    <i data-lucide="truck" class="w-4 h-4"></i> Livraisons
                </button>
                <button data-tab="finances" class="tab-btn px-6 py-4 flex items-center gap-2 border-b-2 font-bold text-sm whitespace-nowrap transition-all border-transparent text-slate-400">
                    <i data-lucide="wallet" class="w-4 h-4"></i> Finances
                </button>
                <button data-tab="clients" class="tab-btn px-6 py-4 flex items-center gap-2 border-b-2 font-bold text-sm whitespace-nowrap transition-all border-transparent text-slate-400">
                    <i data-lucide="users" class="w-4 h-4"></i> Clients
                </button>
            </div>
        </div>

        <main class="max-w-5xl mx-auto w-full p-4 md:p-8">
            <section id="tab-vente" class="tab-content">
                <div class="max-w-2xl mx-auto bg-white rounded-[2.5rem] p-6 md:p-10 shadow-xl border border-white space-y-6">
                    <h2 class="text-xl font-black uppercase text-center text-slate-800">Nouvelle Vente</h2>
                    <div class="relative">
                        <label class="text-[10px] font-black text-indigo-500 uppercase ml-2 mb-1 block">Rechercher Client</label>
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5"></i>
                            <input type="text" id="search-client" placeholder="Nom ou téléphone..." class="w-full p-4 pl-12 bg-slate-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                        <div id="search-results" class="hidden absolute z-10 w-full mt-2 bg-white border rounded-2xl shadow-2xl max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-100">
                        <input type="text" id="order-nom" placeholder="Nom Client" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-medium">
                        <input type="text" id="order-tel" placeholder="Téléphone" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-medium">
                    </div>
                    <input type="text" id="order-lieu" placeholder="Adresse exacte de livraison..." class="w-full p-4 bg-slate-50 rounded-2xl border-none font-medium">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative">
                            <input type="number" id="order-montant" placeholder="Prix" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black text-lg text-indigo-600">
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-400">AR</span>
                        </div>
                        <select id="order-type" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold text-slate-700 appearance-none">
                            <option value="Produit">Produit</option>
                            <option value="Colis">Colis</option>
                        </select>
                    </div>
                    <button id="btn-save-order" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">Valider l'enregistrement</button>
                </div>
            </section>
            <section id="tab-livraisons" class="tab-content hidden"><div id="livraisons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></section>
            <section id="tab-finances" class="tab-content hidden"><div id="stats-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8"></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white rounded-[2rem] border p-6 space-y-4"><h3 class="font-black uppercase text-sm text-green-600 flex items-center gap-2"><i data-lucide="arrow-down-circle"></i> Nouveau Versement</h3><div class="flex gap-2"><input type="number" id="v-montant" placeholder="Montant..." class="flex-1 p-4 bg-slate-50 rounded-2xl font-black"><button id="btn-add-versement" class="bg-green-600 text-white px-6 rounded-2xl font-bold">OK</button></div></div><div class="bg-white rounded-[2rem] border p-6 space-y-4"><h3 class="font-black uppercase text-sm text-rose-600 flex items-center gap-2"><i data-lucide="arrow-up-circle"></i> Nouvelle Dépense</h3><input type="text" id="d-motif" placeholder="Motif..." class="w-full p-4 bg-slate-50 rounded-2xl font-medium"><div class="flex gap-2"><input type="number" id="d-montant" placeholder="Montant..." class="flex-1 p-4 bg-slate-50 rounded-2xl font-black"><button id="btn-add-depense" class="bg-rose-600 text-white px-6 rounded-2xl font-bold">OK</button></div></div></div></section>
            <section id="tab-clients" class="tab-content hidden"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1"><div class="bg-white rounded-[2rem] p-8 border shadow-xl"><h3 class="font-black uppercase mb-6 flex items-center gap-2 text-indigo-600"><i data-lucide="plus"></i> Client</h3><div class="space-y-4"><input type="text" id="c-nom" placeholder="Nom Complet" class="w-full p-4 bg-slate-50 rounded-2xl font-bold"><input type="text" id="c-tel" placeholder="Contact" class="w-full p-4 bg-slate-50 rounded-2xl font-mono font-bold"><input type="text" id="c-lieu" placeholder="Zone" class="w-full p-4 bg-slate-50 rounded-2xl"><button id="btn-add-client" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase mt-4">Ajouter</button></div></div></div><div class="lg:col-span-2 bg-white rounded-[2rem] border overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-[10px] uppercase font-black text-slate-400"><tr><th class="px-6 py-4">Nom</th><th class="px-6 py-4">Tel</th><th class="px-6 py-4">Actions</th></tr></thead><tbody id="clients-list" class="divide-y"></tbody></table></div></div></section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "API_KEY", authDomain: "AUTH_DOMAIN", projectId: "PROJECT_ID", storageBucket: "STORAGE_BUCKET", messagingSenderId: "SENDER_ID", appId: "APP_ID" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rasoa-pro-v1';

        let state = { clients: [], livraisons: [], depenses: [], versements: [] };
        let unsubscribers = [];

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { console.warn("Auth check:", err.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) initListeners();
            else { unsubscribers.forEach(u => u()); unsubscribers = []; }
        });

        window.addEventListener('load', () => {
            if (window.lucide) lucide.createIcons();
            initAuth();
        });

        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const passInput = document.getElementById('admin-password');
        
        const unlock = () => {
            loginScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
            if (window.lucide) lucide.createIcons();
        };

        document.getElementById('login-btn').addEventListener('click', () => {
            if(passInput.value === "rasoa123") unlock();
            else document.getElementById('login-error').classList.remove('hidden');
        });

        document.getElementById('backdoor-btn').addEventListener('click', unlock);

        document.getElementById('logout-btn').addEventListener('click', () => {
            appContent.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            passInput.value = "";
        });

        function initListeners() {
            if (!auth.currentUser) return;
            unsubscribers.forEach(u => u());
            unsubscribers = [];
            const getPath = (n) => collection(db, 'artifacts', appId, 'public', 'data', n);
            const err = (e) => console.log("Firestore error:", e);
            unsubscribers.push(onSnapshot(getPath('clients'), s => { state.clients = s.docs.map(d => ({id: d.id, ...d.data()})); renderClients(); }, err));
            unsubscribers.push(onSnapshot(getPath('livraisons'), s => { state.livraisons = s.docs.map(d => ({id: d.id, ...d.data()})); renderLivraisons(); renderStats(); }, err));
            unsubscribers.push(onSnapshot(getPath('versements'), s => { state.versements = s.docs.map(d => ({id: d.id, ...d.data()})); renderStats(); }, err));
            unsubscribers.push(onSnapshot(getPath('depenses'), s => { state.depenses = s.docs.map(d => ({id: d.id, ...d.data()})); renderStats(); }, err));
        }

        function renderLivraisons() {
            const div = document.getElementById('livraisons-list');
            div.innerHTML = '';
            state.livraisons.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).forEach(l => {
                const color = l.statut === 'Livré' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700';
                div.insertAdjacentHTML('beforeend', `
                    <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm">
                        <div class="py-1 text-[9px] font-black text-center uppercase ${color}">${l.statut}</div>
                        <div class="p-6 space-y-4">
                            <div class="flex justify-between">
                                <h3 class="font-black">${l.nom}</h3>
                                <button onclick="window.delItem('livraisons','${l.id}')" class="text-slate-200 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            <div class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${l.lieu || '-'}</div>
                            <div class="flex justify-between items-center pt-4 border-t">
                                <span class="font-black text-indigo-600">${l.montant.toLocaleString()} Ar</span>
                                ${l.statut !== 'Livré' ? `<button onclick="window.updateStatus('${l.id}','${l.statut}')" class="bg-slate-900 text-white p-2 rounded-xl"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>` : ''}
                            </div>
                        </div>
                    </div>
                `);
            });
            if (window.lucide) lucide.createIcons();
        }

        function renderStats() {
            const totalL = state.livraisons.filter(l => l.statut === "Livré").reduce((a,c) => a + (c.montant||0), 0);
            const totalV = state.versements.reduce((a,c) => a + (c.montant||0), 0);
            const totalD = state.depenses.reduce((a,c) => a + (c.montant||0), 0);
            document.getElementById('stats-container').innerHTML = `
                <div class="bg-white p-6 rounded-3xl border"><div class="text-[10px] font-black text-slate-400 uppercase">Total Livré</div><div class="text-xl font-black">${totalL.toLocaleString()} Ar</div></div>
                <div class="bg-green-50 p-6 rounded-3xl border text-green-700"><div class="text-[10px] font-black uppercase">Encaissé</div><div class="text-xl font-black">${totalV.toLocaleString()} Ar</div></div>
                <div class="bg-rose-50 p-6 rounded-3xl border text-rose-700"><div class="text-[10px] font-black uppercase">Dépenses</div><div class="text-xl font-black">${totalD.toLocaleString()} Ar</div></div>
                <div class="bg-indigo-600 p-6 rounded-3xl text-white shadow-lg"><div class="text-[10px] font-black uppercase opacity-70">Solde</div><div class="text-xl font-black">${(totalV - totalD).toLocaleString()} Ar</div></div>
            `;
        }

        function renderClients() {
            const t = document.getElementById('clients-list');
            t.innerHTML = '';
            state.clients.forEach(c => {
                t.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50"><td class="px-6 py-4 font-bold">${c.nom}</td><td class="px-6 py-4 font-mono text-indigo-600">${c.telephone}</td><td class="px-6 py-4"><button onclick="window.delItem('clients','${c.id}')" class="text-slate-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`);
            });
            if (window.lucide) lucide.createIcons();
        }

        window.delItem = async (col, id) => { if (auth.currentUser) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id)); };
        window.updateStatus = async (id, cur) => { if (auth.currentUser) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', id), { statut: cur === "Préparation" ? "Livraison" : "Livré" }); };
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('border-indigo-600', 'text-indigo-600', 'bg-indigo-50/30');
                b.classList.add('border-transparent', 'text-slate-400');
                if(b.dataset.tab === t) b.classList.add('border-indigo-600', 'text-indigo-600', 'bg-indigo-50/30');
            });
            if (window.lucide) lucide.createIcons();
        };

        document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
        document.getElementById('btn-save-order').addEventListener('click', async () => {
            const nom = document.getElementById('order-nom').value; const montant = document.getElementById('order-montant').value;
            if(!nom || !montant || !auth.currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'livraisons'), { nom, telephone: document.getElementById('order-tel').value, lieu: document.getElementById('order-lieu').value, montant: Number(montant), type: document.getElementById('order-type').value, statut: "Préparation", timestamp: serverTimestamp() });
            ['order-nom','order-tel','order-lieu','order-montant'].forEach(i => document.getElementById(i).value = ""); switchTab('livraisons');
        });

        document.getElementById('btn-add-client').addEventListener('click', async () => {
            const nom = document.getElementById('c-nom').value;
            if(!nom || !auth.currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), { nom, telephone: document.getElementById('c-tel').value, lieu: document.getElementById('c-lieu').value });
            ['c-nom','c-tel','c-lieu'].forEach(i => document.getElementById(i).value = "");
        });

        document.getElementById('btn-add-versement').addEventListener('click', async () => {
            const m = document.getElementById('v-montant').value;
            if(!m || !auth.currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'versements'), { montant: Number(m), timestamp: serverTimestamp() });
            document.getElementById('v-montant').value = "";
        });

        document.getElementById('btn-add-depense').addEventListener('click', async () => {
            const m = document.getElementById('d-montant').value; const mo = document.getElementById('d-motif').value;
            if(!m || !mo || !auth.currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'depenses'), { motif: mo, montant: Number(m), timestamp: serverTimestamp() });
            document.getElementById('d-montant').value = ""; document.getElementById('d-motif').value = "";
        });

        document.getElementById('search-client').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase(); const res = document.getElementById('search-results');
            if(!val) return res.classList.add('hidden');
            const match = state.clients.filter(c => c.nom.toLowerCase().includes(val) || c.telephone.includes(val));
            if(match.length) {
                res.innerHTML = match.map(c => `<div onclick="window.fillClient('${c.nom.replace(/'/g,"\\'")}','${c.telephone}','${(c.lieu||'').replace(/'/g,"\\'")}')" class="p-4 hover:bg-indigo-50 cursor-pointer border-b"><b class="text-indigo-600">${c.nom}</b> - ${c.telephone}</div>`).join('');
                res.classList.remove('hidden');
            } else res.classList.add('hidden');
        });
        window.fillClient = (n, t, l) => { document.getElementById('order-nom').value = n; document.getElementById('order-tel').value = t; document.getElementById('order-lieu').value = l; document.getElementById('search-results').classList.add('hidden'); document.getElementById('search-client').value = ""; };
    </script>
</body>
</html>
