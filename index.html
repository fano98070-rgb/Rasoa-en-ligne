<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasoa Pro - V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-active { color: #4f46e5; background-color: #f5f3ff; border-bottom-color: #4f46e5; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900">

    <div id="app">
        <!-- Écran de Chargement -->
        <div id="loader" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[200]">
            <img src="https://drive.google.com/uc?id=14wx6DlgO3bZ6rSIhQQz6wRzlLrBgwNAp" class="w-24 h-24 mb-6 rounded-full shadow-2xl animate-pulse" alt="Logo Rasoa">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-4"></div>
            <p class="font-black text-indigo-600 uppercase tracking-widest text-[10px]">Initialisation sécurisée...</p>
        </div>

        <!-- Authentification (PIN) -->
        <div id="login-screen" class="hidden fixed inset-0 bg-[#0f172a] flex items-center justify-center p-4 z-[100]">
            <div class="bg-white p-10 rounded-[3rem] w-full max-w-sm text-center shadow-2xl">
                <img src="https://drive.google.com/uc?id=14wx6DlgO3bZ6rSIhQQz6wRzlLrBgwNAp" class="w-24 h-24 rounded-3xl mx-auto mb-8 shadow-xl rotate-3" alt="Logo">
                <h1 class="text-3xl font-black mb-2 uppercase tracking-tighter">Rasoa <span class="text-indigo-600">Pro</span></h1>
                <p class="text-slate-400 text-[10px] mb-8 font-black uppercase tracking-widest">Administration</p>
                <form id="loginForm" class="space-y-4">
                    <input type="password" id="passwordInput" placeholder="PIN" 
                        class="w-full p-6 bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl text-center font-black text-2xl outline-none transition-all tracking-[0.5em]">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl hover:bg-indigo-700 transition-all shadow-xl uppercase tracking-widest text-sm">Se connecter</button>
                </form>
                <p id="loginError" class="hidden mt-6 p-3 bg-rose-50 text-rose-600 text-[10px] font-black rounded-xl uppercase">Code incorrect</p>
            </div>
        </div>

        <!-- Interface Principale -->
        <div id="main-interface" class="hidden min-h-screen flex flex-col">
            <nav class="bg-white/80 backdrop-blur-md border-b px-6 h-20 flex items-center justify-between sticky top-0 z-50">
                <div class="flex items-center gap-3 font-black text-2xl tracking-tighter uppercase">
                    <img src="https://drive.google.com/uc?id=14wx6DlgO3bZ6rSIhQQz6wRzlLrBgwNAp" class="w-10 h-10 rounded-xl shadow-md" alt="Logo mini">
                    RASOA <span class="text-indigo-600">PRO</span>
                </div>
                <button id="logoutBtn" class="bg-rose-50 text-rose-500 p-3 rounded-xl hover:bg-rose-100 transition-all">
                    <i data-lucide="log-out" size="20"></i>
                </button>
            </nav>

            <div class="bg-white border-b overflow-x-auto sticky top-20 z-40 no-scrollbar">
                <div class="max-w-6xl mx-auto px-4 flex">
                    <button onclick="appState.setTab('vente')" id="tab-vente" class="flex-1 py-5 flex flex-col items-center gap-1 font-black text-[10px] uppercase transition-all text-slate-400 border-b-4 border-transparent">
                        <i data-lucide="shopping-cart" size="18"></i> Vente
                    </button>
                    <button onclick="appState.setTab('livraisons')" id="tab-livraisons" class="flex-1 py-5 flex flex-col items-center gap-1 font-black text-[10px] uppercase transition-all text-slate-400 border-b-4 border-transparent">
                        <i data-lucide="truck" size="18"></i> Livraisons
                    </button>
                    <button onclick="appState.setTab('finances')" id="tab-finances" class="flex-1 py-5 flex flex-col items-center gap-1 font-black text-[10px] uppercase transition-all text-slate-400 border-b-4 border-transparent">
                        <i data-lucide="wallet" size="18"></i> Finances
                    </button>
                    <button onclick="appState.setTab('clients')" id="tab-clients" class="flex-1 py-5 flex flex-col items-center gap-1 font-black text-[10px] uppercase transition-all text-slate-400 border-b-4 border-transparent">
                        <i data-lucide="users" size="18"></i> Clients
                    </button>
                </div>
            </div>

            <main class="max-w-6xl mx-auto p-4 md:p-8 flex-1 w-full" id="content-area">
                <!-- Contenu injecté ici -->
            </main>
        </div>

        <!-- Modal Ajout Client -->
        <div id="modal-client" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] flex items-center justify-center p-4">
            <div class="bg-white rounded-[2.5rem] w-full max-w-md p-8 shadow-2xl animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-xl uppercase tracking-tight">Ajouter un Client</h3>
                    <button onclick="appState.closeClientModal()" class="text-slate-400 hover:text-rose-500"><i data-lucide="x" size="24"></i></button>
                </div>
                <form id="addClientForm" class="space-y-4">
                    <input name="nom" required placeholder="Nom complet" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
                    <input name="tel" placeholder="Téléphone" class="w-full p-4 bg-slate-50 rounded-2xl font-mono outline-none">
                    <input name="lieu" placeholder="Adresse / Quartier" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                    <div class="flex gap-2 p-2 bg-slate-50 rounded-2xl">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="source" value="Facebook" class="hidden peer" checked>
                            <div class="flex items-center justify-center gap-2 p-3 rounded-xl peer-checked:bg-white peer-checked:shadow-sm peer-checked:text-blue-600 font-bold transition-all grayscale peer-checked:grayscale-0">
                                <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                <span>FB</span>
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="source" value="TikTok" class="hidden peer">
                            <div class="flex items-center justify-center gap-2 p-3 rounded-xl peer-checked:bg-white peer-checked:shadow-sm peer-checked:text-rose-600 font-bold transition-all grayscale peer-checked:grayscale-0">
                                <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.17-2.89-.6-4.13-1.39-.01 2.53 0 5.06 0 7.59-.11 1.74-.75 3.51-2.04 4.74-1.53 1.54-3.9 2.14-5.96 1.72-2.14-.38-3.96-1.99-4.71-4.04-.84-2.14-.36-4.73 1.25-6.42 1.3-1.4 3.32-2.03 5.2-1.63v4.11c-.71-.16-1.51-.08-2.12.35-.55.37-.88 1.05-.88 1.71.04.85.76 1.6 1.61 1.61.85.01 1.61-.75 1.62-1.6V0z"/></svg>
                                <span>TikTok</span>
                            </div>
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl">Enregistrer Client</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rasoa-pro-v1';

        window.appState = {
            activeTab: 'vente',
            data: { livraisons: [], clients: [], versements: [], depenses: [] },

            setTab(tab) {
                this.activeTab = tab;
                this.render();
            },

            openClientModal() { document.getElementById('modal-client').classList.remove('hidden'); },
            closeClientModal() { document.getElementById('modal-client').classList.add('hidden'); },

            async deleteItem(col, id) {
                if(!confirm('Voulez-vous supprimer cet élément ?')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
                } catch(e) { console.error(e); }
            },

            async updateStatut(id, current) {
                const stages = ['Préparation', 'En cours', 'Livré'];
                const next = stages[stages.indexOf(current) + 1] || 'Livré';
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'livraisons', id), { statut: next });
                } catch(e) { console.error(e); }
            },

            render() {
                const tabs = ['vente', 'livraisons', 'finances', 'clients'];
                tabs.forEach(t => {
                    const el = document.getElementById(`tab-${t}`);
                    if (el) t === this.activeTab ? el.classList.add('tab-active') : el.classList.remove('tab-active');
                });

                const container = document.getElementById('content-area');
                if (container) {
                    container.innerHTML = `<div class="animate-fade-in">${this.getTemplate()}</div>`;
                    lucide.createIcons();
                    this.bindEvents();
                }
            },

            getTemplate() {
                if (this.activeTab === 'vente') return this.templateVente();
                if (this.activeTab === 'livraisons') return this.templateLivraisons();
                if (this.activeTab === 'finances') return this.templateFinances();
                if (this.activeTab === 'clients') return this.templateClients();
                return '';
            },

            templateVente() {
                return `
                <div class="max-w-xl mx-auto bg-white rounded-[3rem] p-8 shadow-xl border border-indigo-50 space-y-8">
                    <div class="text-center">
                        <img src="https://drive.google.com/uc?id=14wx6DlgO3bZ6rSIhQQz6wRzlLrBgwNAp" class="w-16 h-16 rounded-2xl mx-auto mb-4" alt="logo form">
                        <h2 class="text-2xl font-black uppercase">Nouvelle Commande</h2>
                    </div>
                    <form id="venteForm" class="space-y-4">
                        <input name="nom" required placeholder="Nom du client" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
                        <input name="tel" placeholder="Téléphone" class="w-full p-4 bg-slate-50 rounded-2xl font-mono outline-none">
                        <input name="lieu" placeholder="Adresse de livraison" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex gap-2 p-2 bg-slate-50 rounded-2xl">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="source" value="Facebook" class="hidden peer" checked>
                                    <div class="flex items-center justify-center p-3 rounded-xl peer-checked:bg-white peer-checked:text-blue-600 grayscale peer-checked:grayscale-0 transition-all"><i data-lucide="facebook" size="20"></i></div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="source" value="TikTok" class="hidden peer">
                                    <div class="flex items-center justify-center p-3 rounded-xl peer-checked:bg-white peer-checked:text-rose-600 grayscale peer-checked:grayscale-0 transition-all">
                                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.17-2.89-.6-4.13-1.39-.01 2.53 0 5.06 0 7.59-.11 1.74-.75 3.51-2.04 4.74-1.53 1.54-3.9 2.14-5.96 1.72-2.14-.38-3.96-1.99-4.71-4.04-.84-2.14-.36-4.73 1.25-6.42 1.3-1.4 3.32-2.03 5.2-1.63v4.11c-.71-.16-1.51-.08-2.12.35-.55.37-.88 1.05-.88 1.71.04.85.76 1.6 1.61 1.61.85.01 1.61-.75 1.62-1.6V0z"/></svg>
                                    </div>
                                </label>
                            </div>
                            <input name="montant" type="number" required placeholder="Prix AR" class="p-4 bg-indigo-50 rounded-2xl font-black text-indigo-600 outline-none">
                        </div>
                        <button type="submit" class="w-full bg-slate-900 text-white py-6 rounded-3xl font-black uppercase tracking-widest shadow-lg hover:bg-indigo-600 transition-all">Enregistrer la vente</button>
                    </form>
                </div>`;
            },

            templateLivraisons() {
                const list = this.data.livraisons;
                if (list.length === 0) return `<div class="text-center py-20 text-slate-300 font-bold uppercase tracking-widest">Aucune livraison en attente</div>`;
                return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${list.map(l => `
                        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col hover:shadow-md transition-all">
                            <div class="py-2 text-[8px] font-black uppercase text-center text-white ${l.statut === 'Livré' ? 'bg-emerald-500' : l.statut === 'En cours' ? 'bg-blue-500' : 'bg-amber-400'}">${l.statut}</div>
                            <div class="p-6 flex-1">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-black text-lg">${l.nom}</h3>
                                        <div class="flex items-center gap-1 text-[10px] font-black uppercase ${l.source === 'Facebook' ? 'text-blue-600' : 'text-rose-500'}">
                                            ${l.source === 'Facebook' ? '<i data-lucide="facebook" size="10"></i>' : '<i data-lucide="music" size="10"></i>'} ${l.source}
                                        </div>
                                    </div>
                                    <button onclick="appState.deleteItem('livraisons', '${l.id}')" class="text-slate-200 hover:text-rose-500"><i data-lucide="trash-2" size="14"></i></button>
                                </div>
                                <div class="font-black text-2xl mb-4 text-indigo-600">${(l.montant || 0).toLocaleString()} <span class="text-xs">AR</span></div>
                                <div class="text-xs text-slate-400 font-bold uppercase mb-6"><i data-lucide="map-pin" size="12" class="inline"></i> ${l.lieu || 'Sans adresse'}</div>
                                ${l.statut !== 'Livré' ? `<button onclick="appState.updateStatut('${l.id}', '${l.statut}')" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-indigo-600 transition-all">Étape Suivante</button>` : '<div class="text-center text-emerald-500 py-4 font-black uppercase text-[10px] tracking-widest bg-emerald-50 rounded-xl">Livrée ✔️</div>'}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            },

            templateFinances() {
                const totalVer = this.data.versements.reduce((a,c) => a + (Number(c.montant) || 0), 0);
                const totalDep = this.data.depenses.reduce((a,c) => a + (Number(c.montant) || 0), 0);
                return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                        <div class="relative z-10">
                            <span class="text-[10px] font-black uppercase opacity-70">Revenus de vente</span>
                            <div class="text-4xl font-black mt-2">${totalVer.toLocaleString()} AR</div>
                        </div>
                        <i data-lucide="trending-up" size="120" class="absolute -right-8 -bottom-8 opacity-10 rotate-12"></i>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 flex flex-col justify-center">
                        <span class="text-[10px] font-black uppercase text-slate-400">Solde Actuel</span>
                        <div class="text-4xl font-black mt-2 text-slate-900">${(totalVer - totalDep).toLocaleString()} AR</div>
                    </div>
                </div>
                <div class="text-center p-20 border-2 border-dashed border-slate-200 rounded-[3rem] text-slate-300 font-black uppercase tracking-widest text-xs">
                    Historique des transactions vide
                </div>`;
            },

            templateClients() {
                return `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black uppercase tracking-tighter">Répertoire Clients</h2>
                    <button onclick="appState.openClientModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-black text-xs uppercase flex items-center gap-2 shadow-lg shadow-indigo-100"><i data-lucide="plus" size="16"></i> Nouveau Client</button>
                </div>
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b">
                            <tr>
                                <th class="p-6">Source</th>
                                <th class="p-6">Client / Adresse</th>
                                <th class="p-6">Contact</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${this.data.clients.map(c => `
                                <tr class="hover:bg-indigo-50/30 transition-colors">
                                    <td class="p-6">
                                        <div class="w-10 h-10 rounded-xl flex items-center justify-center ${c.source === 'TikTok' ? 'bg-rose-50 text-rose-500' : 'bg-blue-50 text-blue-600'}">
                                            ${c.source === 'TikTok' ? '<svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.17-2.89-.6-4.13-1.39-.01 2.53 0 5.06 0 7.59-.11 1.74-.75 3.51-2.04 4.74-1.53 1.54-3.9 2.14-5.96 1.72-2.14-.38-3.96-1.99-4.71-4.04-.84-2.14-.36-4.73 1.25-6.42 1.3-1.4 3.32-2.03 5.2-1.63v4.11c-.71-.16-1.51-.08-2.12.35-.55.37-.88 1.05-.88 1.71.04.85.76 1.6 1.61 1.61.85.01 1.61-.75 1.62-1.6V0z"/></svg>' : '<i data-lucide="facebook" size="20"></i>'}
                                        </div>
                                    </td>
                                    <td class="p-6">
                                        <div class="font-black text-slate-900">${c.nom}</div>
                                        <div class="text-[10px] text-slate-400 font-bold uppercase">${c.lieu || 'Sans quartier'}</div>
                                    </td>
                                    <td class="p-6 font-mono font-black text-indigo-600 text-sm">${c.tel || '-'}</td>
                                    <td class="p-6 text-right">
                                        <button onclick="appState.deleteItem('clients', '${c.id}')" class="text-slate-100 hover:text-rose-500 p-2"><i data-lucide="trash-2" size="16"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            },

            bindEvents() {
                // Formulaire Vente
                const venteForm = document.getElementById('venteForm');
                if (venteForm) {
                    venteForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const fd = new FormData(venteForm);
                        const obj = Object.fromEntries(fd.entries());
                        try {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'livraisons'), {
                                ...obj, montant: Number(obj.montant), statut: 'Préparation', timestamp: serverTimestamp()
                            });
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), {
                                nom: obj.nom, tel: obj.tel, lieu: obj.lieu, source: obj.source, createdAt: serverTimestamp()
                            });
                            this.setTab('livraisons');
                        } catch(err) { console.error(err); }
                    };
                }

                // Formulaire Ajout Client Manuel
                const clientForm = document.getElementById('addClientForm');
                if (clientForm) {
                    clientForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const fd = new FormData(clientForm);
                        const obj = Object.fromEntries(fd.entries());
                        try {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), {
                                ...obj, createdAt: serverTimestamp()
                            });
                            this.closeClientModal();
                        } catch(err) { console.error(err); }
                    };
                }
            }
        };

        const setupListeners = () => {
            const cols = ['livraisons', 'clients', 'versements', 'depenses'];
            cols.forEach(name => {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', name));
                onSnapshot(q, snap => {
                    appState.data[name] = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    appState.render();
                }, err => console.error(`Erreur ${name}:`, err));
            });
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                setupListeners();
                checkLocalSession();
                setTimeout(() => document.getElementById('loader').classList.add('hidden'), 1000);
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
            }
        });

        const checkLocalSession = () => {
            const isLogged = localStorage.getItem('rasoa_session') === 'active';
            document.getElementById('login-screen').classList.toggle('hidden', isLogged);
            document.getElementById('main-interface').classList.toggle('hidden', !isLogged);
            if (isLogged) appState.render();
            lucide.createIcons();
        };

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            if (document.getElementById('passwordInput').value === 'rasoa123') {
                localStorage.setItem('rasoa_session', 'active');
                checkLocalSession();
            } else { document.getElementById('loginError').classList.remove('hidden'); }
        };

        document.getElementById('logoutBtn').onclick = () => {
            localStorage.removeItem('rasoa_session');
            checkLocalSession();
        };
    </script>
</body>
</html>
